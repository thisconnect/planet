#! /usr/bin/env node

var http = require('http'),
	io = require('socket.io'),
	optparse = require('optparse').OptionParser,
	Planet = require('../planet');

var port = 8004,
	host = '127.0.0.1',
	options = {};

var parser = new optparse([
	['-p', '--port PORT', 'The port to bind to (default: 8004)']
	, ['', '--host HOST', 'The host to connect to (default: 127.0.0.1)']
	, ['-l', '--limit [NUMBER]', 'Maximum concurrent client connections, a number lower than your ulimit (default: 200)']
	, ['-h', '--help', 'Shows this help message']
]);

parser.banner = 'Usage: planet [--port PORT] [--host HOST]';

parser.on('*', function(opt, value){
	switch (opt){
		case 'port': port = value || port; break;
		case 'host': host = value || host; break;
		case 'limit': options.limit = parseInt(value); break;
		case 'help':
			console.log(this.toString());
			parser.halt();
			process.exit(0);
		break;
	}
});

parser.parse(process.argv);


var server = http.createServer();

var socket = io.listen(server, {
	'transports': ['websocket']
	, 'flash policy server': false
	, 'log level': 1
	//, 'browser client': false
	//, 'browser client cache': true
	//, 'browser client minification': true
	//, 'browser client gzip': true
});

new Planet(socket, options)
	.on('listening', function(location, port){
		console.log('Planet started at ' + [location, port].join(':'));
	});

server.listen(port, host);
